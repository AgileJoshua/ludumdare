#!/usr/bin/env php
<?php
require_once __DIR__."/../../db.php";
require_once __DIR__."/../../core/internal/core.php";

db_Connect();

if ( !db_IsConnected() ) {
	echo "Failed to connect to Database. Retrying as server only...";
	
	db_ConnectOnly();

	if ( !db_IsConnected() ) {
		db_Log("Failed to connect to Server");
		exit(1);
	}

	// If DB doesn't exist, create it //
	if ( !db_DatabaseExists(CMW_DB_NAME) ) {
		db_DoQuery("CREATE DATABASE IF NOT EXISTS ?;",CMW_DB_NAME);
		echo("Database '".CMW_DB_NAME."' created.\n");
	
		// Reconnect //
		db_Close();
		db_Connect();
	
		if ( !db_IsConnected() ) {
			db_Log("Failed to reconnect to Database '".CMW_DB_NAME."'");
			exit(1);
		}
		
		echo "Reconnected.\n";
	}
}

echo "Connected.\n";


//$data = db_DoFetchKey("id","SELECT id,type,name FROM cmw_node WHERE type=? LIMIT ?;",
//	"game",
//	"4"
//);
$data = db_DoFetch("SELECT id,type,name FROM cmw_node WHERE type=? LIMIT ?;",
	"event",
	3
);

if ( !empty($data) ) {
	print_r($data);
}
else {
	echo "nope";
}


// Database Setup //
db_DoQuery("SET storage_engine=InnoDB;");
//db_Query("SET collation_server=utf8_unicode_ci;");
//db_Query("SET character_set_server=utf8;");

print_r( db_DoFetchFirst("SHOW tables;") );

exit(0);

const DBTYPE_INNODB = " ENGINE=InnoDB";
// NOTE: utf8 is 3 byte unicode. utf8mb4 is 4 byte. Required for Emoji.
const CSTYPE_UTF8 = " CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci";
const CSTYPE_LATIN = " CHARACTER SET latin1 COLLATE latin1_swedish_ci";		// Case Insensitive
//const CSTYPE_LATIN = " CHARACTER SET latin1 COLLATE latin1_bin";			// Case Sensitive

// https://dev.mysql.com/doc/refman/5.5/en/case-sensitivity.html

const DBTYPE_DEFAULT = DBTYPE_INNODB . CSTYPE_UTF8;


// Fetch Internal Config (State, Table Versions) //
$Internal = [
//	'version-cmw_suggestion' <= 1
];

function SaveInternal( $key ) {
	global $Internal;
	
	// Write key
	echo $key."\n";
}


{
	// Suggestion Table //
	$table_name = "cmw_suggestion";
	$table_version = 0;
	$original_version = 0;
	if ( isset($Internal['version-'.$table_name]) ) {
		$original_version = intval($Internal['version-'.$table_name]);
		$table_version = $original_version;
	}
	$break_on = null;
	
	// NOTE: Break is optional!
	switch ( $table_version ) {
		case 0: {
			echo("Create\n");
			//db_Query("");
			
			if ( ++$table_version == $break_on ) break;
		}
		case 1: {
			echo("Alter\n");
			
			if ( ++$table_version == $break_on ) break;
		}
		case 2: {
			echo("Alter\n");
			
			if ( ++$table_version == $break_on ) break;
		}
	}
	if ( $original_version != $table_version ) {
		$Internal['version-'.$table_name] = $table_version;
		SaveInternal('version-'.$table_name);
		
		echo("Upgraded '".$table_name."' from ".$original_version." to ".$table_version."\n");
		
		// TODO: SQL Dump Table nice format??
	}
}



